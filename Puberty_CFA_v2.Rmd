---
title: "Puberty CFA version 2"
author: "Sam Chavez and Michelle Byrne"
date: "May 27, 2019"
output: html_document
---

## Set Working Directory
```{r Set Directory, message=FALSE, warning=FALSE, include=FALSE}
getwd()
#You should set this to the behavioral directory on the TAG file server 
workdir='Z:/dsnlab/TAG/behavior/' 
```

## Loading Libraries

```{r libraries, include = F}
library(tidyverse)
library(lavaan)
library(semPlot)
library(reshape2)
library(dplyr)
library(Hmisc)
library(corrplot)
library(lmtest)
library(nlsem)
```

## Load and Clean Data
```{r Load and Clean Data}
# Load Data
saliva <- read.csv(file.path(workdir,"Puberty/Saliva/Wave1/TAG_W1_Saliva_wide_cens_only4.csv", fsep=""))
hair <- read.csv(file.path(workdir,"Puberty/Hair/Wave1/TAG_W1_Hair_processed.csv", fsep=""))
qs <- read.csv(file.path(workdir,"Questionnaires/Puberty/Composite/TAG_W1_PubertyComposite.csv", fsep=""))

# Reformat & Merge Data

# Transforming Hair Data into Wide Format
hair <- dcast(hair, SID ~ hormone, value.var = "concentration_ln")
colnames(hair) <- c("SID","dhea_hair","estr_hair","test_hair")

# Getting rid of Saliva clutter
sal_dhea <- select(saliva, "SID", "sal_DHEA_conc_ln_w_1", "sal_DHEA_conc_ln_w_2", 
               "sal_DHEA_conc_ln_w_3", "sal_DHEA_conc_ln_w_4")
colnames(sal_dhea) <- c("SID","dhea1","dhea2","dhea3","dhea4")
sal_estr <- select(saliva, "SID", "sal_EST_conc_ln_w_1", "sal_EST_conc_ln_w_2", 
               "sal_EST_conc_ln_w_3", "sal_EST_conc_ln_w_4")
colnames(sal_estr) <- c("SID","estr1","estr2","estr3","estr4")
sal_test <- select(saliva, "SID", "sal_TEST_conc_ln_w_1", "sal_TEST_conc_ln_w_2", 
               "sal_TEST_conc_ln_w_3", "sal_TEST_conc_ln_w_4")
colnames(sal_test) <- c("SID","test1","test2","test3","test4")

# Re-Merging Saliva Data
saliva <- sal_dhea %>% full_join(sal_estr, by = "SID") %>% full_join(sal_test, by = "SID")

# Getting rid of Questionnaire Clutter
sr_qs <- select(qs, "SID", "PDS_F1", "PDS_F2", "PDS_F3", 
                "PDS_F4", "PDS_F6", "PBIP_1A", "PBIP_2A")
colnames(sr_qs) <- c("SID","PDS1","PDS2","PDS3",
                     "PDS4","PDS6","PBIP1","PBIP2")

# Making one big pretty data frame
hormones <- saliva %>% full_join(hair, by = "SID")
hormones_complete_E2hair <- filter(hormones, !is.na(estr_hair))
data <- hormones %>% full_join(sr_qs, by = "SID")

# Count missing data by variable
missing <- data.frame(matrix(ncol = 44, nrow = 1))
colnames(missing) <- c("na_dhea1","percna_dhea1","na_dhea2","percna_dhea2","na_dhea3",
                       "percna_dhea3","na_dhea4","percna_dhea4","na_estr1","percna_estr1",
                       "na_estr2","percna_estr2","na_estr3","percna_estr3","na_estr4",
                       "percna_estr4","na_test1","percna_test1","na_test2","percna_test2",
                       "na_test3","percna_test3","na_test4","percna_test4","na_dhea_hair",
                       "percna_dhea_hair","na_estr_hair","percna_estr_hair",
                       "na_test_hair","percna_test_hair","na_PDS1","percna_PDS1",
                       "na_PDS2","percna_PDS2","na_PDS3","percna_PDS3","na_PDS4",
                       "percna_PDS4","na_PDS6","percna_PDS6","na_PBIP1","percna_PBIP1",
                       "na_PBIP2","percna_PBIP2")
missing$na_dhea1 <- length(data$dhea1)-length(na.omit(data$dhea1))
missing$percna_dhea1 <- (missing$na_dhea1/length(data$dhea1))*100
missing$na_dhea2 <- length(data$dhea2)-length(na.omit(data$dhea2))
missing$percna_dhea2 <- (missing$na_dhea2/length(data$dhea2))*100
missing$na_dhea3 <- length(data$dhea3)-length(na.omit(data$dhea3))
missing$percna_dhea3 <- (missing$na_dhea3/length(data$dhea3))*100
missing$na_dhea4 <- length(data$dhea4)-length(na.omit(data$dhea4))
missing$percna_dhea4 <- (missing$na_dhea4/length(data$dhea4))*100
missing$na_estr1 <- length(data$estr1)-length(na.omit(data$estr1))
missing$percna_estr1 <- (missing$na_estr1/length(data$estr1))*100
missing$na_estr2 <- length(data$estr2)-length(na.omit(data$estr2))
missing$percna_estr2 <- (missing$na_estr2/length(data$estr2))*100
missing$na_estr3 <- length(data$estr3)-length(na.omit(data$estr3))
missing$percna_estr3 <- (missing$na_estr3/length(data$estr3))*100
missing$na_estr4 <- length(data$estr4)-length(na.omit(data$estr4))
missing$percna_estr4 <- (missing$na_estr4/length(data$estr4))*100
missing$na_test1 <- length(data$test1)-length(na.omit(data$test1))
missing$percna_test1 <- (missing$na_test1/length(data$test1))*100
missing$na_test2 <- length(data$test2)-length(na.omit(data$test2))
missing$percna_test2 <- (missing$na_test2/length(data$test2))*100
missing$na_test3 <- length(data$test3)-length(na.omit(data$test3))
missing$percna_test3 <- (missing$na_test3/length(data$test3))*100
missing$na_test4 <- length(data$test4)-length(na.omit(data$test4))
missing$percna_test4 <- (missing$na_test4/length(data$test4))*100

missing$na_dhea_hair <- length(data$dhea_hair)-length(na.omit(data$dhea_hair))
missing$percna_dhea_hair <- (missing$na_dhea_hair/length(data$dhea_hair))*100
missing$na_estr_hair <- length(data$estr_hair)-length(na.omit(data$estr_hair))
missing$percna_estr_hair <- (missing$na_estr_hair/length(data$estr_hair))*100
missing$na_test_hair <- length(data$test_hair)-length(na.omit(data$test_hair))
missing$percna_test_hair <- (missing$na_test_hair/length(data$test_hair))*100

missing$na_PDS1 <- length(data$PDS1)-length(na.omit(data$PDS1))
missing$percna_PDS1 <- (missing$na_PDS1/length(data$PDS1))*100
missing$na_PDS2 <- length(data$PDS2)-length(na.omit(data$PDS2))
missing$percna_PDS2 <- (missing$na_PDS2/length(data$PDS2))*100
missing$na_PDS3 <- length(data$PDS3)-length(na.omit(data$PDS3))
missing$percna_PDS3 <- (missing$na_PDS3/length(data$PDS3))*100
missing$na_PDS4 <- length(data$PDS4)-length(na.omit(data$PDS4))
missing$percna_PDS4 <- (missing$na_PDS4/length(data$PDS4))*100
missing$na_PDS6 <- length(data$PDS6)-length(na.omit(data$PDS6))
missing$percna_PDS6 <- (missing$na_PDS6/length(data$PDS6))*100
missing$na_PBIP1 <- length(data$PBIP1)-length(na.omit(data$PBIP1))
missing$percna_PBIP1 <- (missing$na_PBIP1/length(data$PBIP1))*100
missing$na_PBIP2 <- length(data$PBIP2)-length(na.omit(data$PBIP2))
missing$percna_PBIP2 <- (missing$na_PBIP2/length(data$PBIP2))*100

# Specifying PDS & PBIP variables as ordinal
data_ord <- data
data_menarche <- data
data_mpbip <- data
data_ord[, 17:23] <- lapply(data_ord[, 17:23], ordered)
data_menarche$PDS6 <- ordered(data_menarche$PDS6)
data_mpbip[, 21:23] <- lapply(data_mpbip[, 21:23], ordered)
```

## PART 1: SELF-REPORT MODELS ONLY 
```{r SRMs}

# Define SRM1 - Self-Report Only with 1 Puberty Factor. No covariances

model_sr1_nocov <- "
#Latent Neuroendocrine Systems
puberty =~ PDS1 + PDS2 + PDS3 + PDS4 + PDS6 + PBIP1 + PBIP2
"
# Define SRM3 - Self-Report Only with 1 Puberty Factor. WITH covariances. No covar on PDS6
model_sr3 <- "
#Latent Neuroendocrine Systems
puberty =~ PDS1 + PDS2 + PDS3 + PDS4 + PDS6 + PBIP1 + PBIP2

#Covariances for questionnaires
PDS1 ~~ PDS2 + PDS3 + PDS4
PDS2 ~~ PDS3 + PDS4
PDS3 ~~ PDS4
PBIP1 ~~ PBIP2
"

#Other stuff not using for now
#model_sr1_noPDS1 <- "
##Latent Neuroendocrine Systems
#puberty =~ PDS2 + PDS3 + PDS4 + PDS6 + PBIP1 + PBIP2

##Covariances for questionnaires
#PDS2 ~~ PDS3 + PDS4
#PDS3 ~~ PDS4
#PBIP1 ~~ PBIP2
#"

#model_sr1_noPDS1_nocov <- "
##Latent Neuroendocrine Systems
#puberty =~ PDS2 + PDS3 + PDS4 + PDS6 + PBIP1 + PBIP2
#"

#model_sr1_nocov_noPBIP <- "
##Latent Neuroendocrine Systems
#puberty =~ PDS1 + PDS2 + PDS3 + PDS4 + PDS6
#"

# Define SRM2 - Self-Report Only with 2 Puberty Factors (Adrenal & Gonadal). No covariances.

model_sr2_nocov <- "
#Latent Neuroendocrine Systems
adrenal =~ PDS2 + PDS3 + PBIP2
gonadal =~ PDS1 + PDS4 + PDS6 + PBIP1
"

# Define SRM4 - Self-Report Only with 2 Puberty Factors (Adrenal & Gonadal). WITH covariances.
model_sr4 <- "
#Latent Neuroendocrine Systems
adrenal =~ PDS2 + PDS3 + PBIP2
gonadal =~ PDS1 + PDS4 + PDS6 + PBIP1

#Covariances for questionnaires (minus pds6)
PDS1 ~~ PDS2 + PDS3 + PDS4
PDS2 ~~ PDS3 + PDS4
PDS3 ~~ PDS4
PBIP1 ~~ PBIP2
"

#Other stuff not using for now
#model_sr2_noPDS1 <- "
##Latent Neuroendocrine Systems
#adrenal =~ PDS2 + PDS3 + PBIP2
#gonadal =~ PDS4 + PDS6 + PBIP1

##Covariances for questionnaires
#PDS2 ~~ PDS3 + PDS4
#PDS3 ~~ PDS4
#PBIP1 ~~ PBIP2
#"

#model_sr2_noPDS1_nocov <- "
##Latent Neuroendocrine Systems
#adrenal =~ PDS2 + PDS3 + PBIP2
#gonadal =~ PDS4 + PDS6 + PBIP1
#"

#model_sr2_nocov_noPBIP <- "
##Latent Neuroendocrine Systems
#adrenal =~ PDS2 + PDS3
#gonadal =~ PDS1 + PDS4 + PDS6
#"

# Fit Self-Report CFAs (ordinal data) - WLSMV - NOT USING ONLY USE PML
#fit_model_sr1_ord <- cfa(model_sr1, data = data_ord, estimator = "WLSMV", 
#                       missing = "pairwise", verbose = T)
#fit_model_sr1_ord_nocov <- cfa(model_sr1_nocov, data = data_ord, 
#                                  estimator = "WLSMV", 
#                       missing = "pairwise", verbose = T)
#fit_model_sr1_ord_noPDS1 <- cfa(model_sr1_noPDS1, data = data_ord, 
#                                   estimator = "WLSMV", 
#                       missing = "pairwise", verbose = T)
#fit_model_sr1_ord_noPDS1_nocov <- cfa(model_sr1_noPDS1_nocov, data = data_ord, 
#                                   estimator = "WLSMV", 
#                       missing = "pairwise", verbose = T)
#fit_model_sr1_ord_nocov_noPBIP <- cfa(model_sr1_nocov_noPBIP, data = data_ord, 
#                                   estimator = "WLSMV", 
#                       missing = "pairwise", verbose = T)
#
#fit_model_sr2_ord <- cfa(model_sr2, data = data_ord, estimator = "WLSMV", 
#                       missing = "pairwise", verbose = T)
#fit_model_sr2_ord_nocov <- cfa(model_sr2_nocov, data = data_ord, 
#                                 estimator = "WLSMV", 
#                       missing = "pairwise", verbose = T)
#fit_model_sr2_ord_noPDS1 <- cfa(model_sr2_noPDS1, data = data_ord, 
#                                  estimator = "WLSMV", 
#                       missing = "pairwise", verbose = T)
#fit_model_sr2_ord_noPDS1_nocov <- cfa(model_sr2_noPDS1_nocov, data = data_ord, 
#                                  estimator = "WLSMV", 
#                       missing = "pairwise", verbose = T)
#fit_model_sr2_ord_nocov_noPBIP <- cfa(model_sr2_nocov_noPBIP, data = data_ord, 
#                                   estimator = "WLSMV", 
#                       missing = "pairwise", verbose = T)


# ** Fit Self-Report CFAs (ordinal data) - PML - USE THIS **
fit_model_sr1_pml_nocov <- cfa(model_sr1_nocov, data = data, estimator = "PML", 
                      missing = "available.cases", verbose = T,  
                     ordered = c("PDS1","PDS2","PDS3","PDS4",
                                 "PDS6","PBIP1","PBIP2"))

fit_model_sr2_pml_nocov <- cfa(model_sr2_nocov, data = data, estimator = "PML", 
                      missing = "available.cases", verbose = T,  
                     ordered = c("PDS1","PDS2","PDS3","PDS4",
                                 "PDS6","PBIP1","PBIP2"))

fit_model_sr3_pml <- cfa(model_sr3, data = data, estimator = "PML", 
                      missing = "available.cases", verbose = T,  
                     ordered = c("PDS1","PDS2","PDS3","PDS4",
                                 "PDS6","PBIP1","PBIP2"))

fit_model_sr4_pml <- cfa(model_sr4, data = data, estimator = "PML", 
                      missing = "available.cases", verbose = T,  
                     ordered = c("PDS1","PDS2","PDS3","PDS4",
                                 "PDS6","PBIP1","PBIP2"))

#fit_model_sr1_pml_noPDS1 <- cfa(model_sr1_noPDS1, data = data, estimator = "PML",
#                      missing = "available.cases", verbose = T,  
#                     ordered = c("PDS1","PDS2","PDS3","PDS4",
#                                 "PDS6","PBIP1","PBIP2"))
#fit_model_sr1_pml_noPDS1_nocov <- cfa(model_sr1_noPDS1_nocov, data = data, 
#                                      estimator = "PML",
#                      missing = "available.cases", verbose = T,  
#                     ordered = c("PDS1","PDS2","PDS3","PDS4",
#                                 "PDS6","PBIP1","PBIP2"))
#
#fit_model_sr1_pml_nocov_noPBIP <- cfa(model_sr1_nocov_noPBIP, data = data, estimator = "PML", 
#                      missing = "available.cases", verbose = T,  
#                     ordered = c("PDS1","PDS2","PDS3","PDS4",
#                                 "PDS6"))
#
#fit_model_sr2_pml_noPDS1 <- cfa(model_sr2_noPDS1, data = data, estimator = "PML", 
#                      missing = "available.cases", verbose = T,  
#                     ordered = c("PDS1","PDS2","PDS3","PDS4",
#                                 "PDS6","PBIP1","PBIP2")
#
#fit_model_sr2_pml_noPDS1_nocov <- cfa(model_sr2_noPDS1_nocov, data = data, 
#                                      estimator = "PML", 
#                      missing = "available.cases", verbose = T,  
#                     ordered = c("PDS1","PDS2","PDS3","PDS4",
#                                 "PDS6","PBIP1","PBIP2"))
#fit_model_sr2_pml_nocov_noPBIP <- cfa(model_sr2_nocov_noPBIP, data = data, estimator = "PML", 
#                      missing = "available.cases", verbose = T,  
#                     ordered = c("PDS1","PDS2","PDS3","PDS4",
#                                 "PDS6")) # Note this comes up with the dread pirate NOT POSITIVE DEFINITE

# Fit Self-Report CFAs (continuous data)
#fit_model_sr1_cont <- cfa(model_sr1, data = data, 
#                     missing = "pairwise",
#                     verbose = T)
#fit_model_sr1_cont_nocov <- cfa(model_sr1_nocov, data = data, 
#                     missing = "pairwise",
#                     verbose = T)
#fit_model_sr1_cont_noPDS1 <- cfa(model_sr1_noPDS1, data = data, 
#                     missing = "pairwise",
#                     verbose = T)
#fit_model_sr1_cont_noPDS1_nocov <- cfa(model_sr1_noPDS1_nocov, data = data, 
#                     missing = "pairwise",
#                     verbose = T)
#
#fit_model_sr2_cont <- cfa(model_sr2, data = data, 
#                        missing = "pairwise",
#                        verbose = T)
#fit_model_sr2_cont_nocov <- cfa(model_sr2_nocov, data = data, 
#                        missing = "pairwise",
#                        verbose = T)
#fit_model_sr2_cont_noPDS1 <- cfa(model_sr2_noPDS1, data = data, 
#                     missing = "pairwise",
#                     verbose = T)
#fit_model_sr2_cont_noPDS1_nocov <- cfa(model_sr2_noPDS1_nocov, data = data, 
#                     missing = "pairwise",
#                     verbose = T)


# Model Stats & Comparison 

#Do we need covariances between items of the same questionnaire?

#anova(fit_model_sr1_ord, fit_model_sr1_ord_nocov)
#anova(fit_model_sr1_ord_noPDS1, fit_model_sr1_ord_noPDS1_nocov)
anova(fit_model_sr3_pml, fit_model_sr1_pml_nocov) # 1 factor models
#anova(fit_model_sr1_pml_noPDS1, fit_model_sr1_pml_noPDS1_nocov)
#anova(fit_model_sr2_ord, fit_model_sr2_ord_nocov)
#anova(fit_model_sr2_ord_noPDS1, fit_model_sr2_ord_noPDS1_nocov)
anova(fit_model_sr4_pml, fit_model_sr2_pml_nocov) # 2 factor models
#anova(fit_model_sr2_pml_noPDS1, fit_model_sr2_pml_noPDS1_nocov)
#For all models, adding covariances for self-report Qs does not increase model fit indices.


#Should we include PDS1?
#fitmeasures(fit_model_sr1_ord_nocov,
#            fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))
#summary(fit_model_sr1_ord_nocov, fit.measures = T, standardized = T)
#fitmeasures(fit_model_sr1_ord_noPDS1_nocov,
#            fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))
#fitmeasures(fit_model_sr1_pml_nocov,
#            fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))
#fitmeasures(fit_model_sr1_pml_noPDS1_nocov,
#            fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))
#model with PDS1 is slightly better for most fit indices in AG models
#fitmeasures(fit_model_sr2_ord_nocov,
#            fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))
#summary(fit_model_sr2_ord_nocov, fit.measures = T, standardized = T)
#
#fitmeasures(fit_model_sr2_ord_noPDS1_nocov,
#            fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))
#fitmeasures(fit_model_sr2_pml_nocov,
#            fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))
#fitmeasures(fit_model_sr2_pml_noPDS1_nocov,
#            fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))
#model with PDS1 is slightly better for most fit indices in P models
#leaving PDS1 in the model from this point forward


#Is self-reported puberty better captured by A+G or P? 

#WLSMV - don't use
#summary(fit_model_sr1_ord_nocov, fit.measures = T, standardized = T)
#summary(fit_model_sr2_ord_nocov, fit.measures = T, standardized = T)
#anova(fit_model_sr1_ord_nocov, fit_model_sr2_ord_nocov)
#lavTestLRT(fit_model_sr1_ord_nocov, fit_model_sr2_ord_nocov)
#fitmeasures(fit_model_sr1_ord_nocov,
#            fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))
#fitmeasures(fit_model_sr2_ord_nocov,
#            fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))
#AG fits better than P for model with NO covariances between items of the same questionnaire,
#data treated as ordinal, and wlsmv estimator (p<0.05)

# One vs 2 factor for models - NO covariances
summary(fit_model_sr1_pml_nocov, fit.measures = T, standardized = T)
summary(fit_model_sr2_pml_nocov, fit.measures = T, standardized = T)
lavTestLRT(fit_model_sr1_pml_nocov, fit_model_sr2_pml_nocov)
fitmeasures(fit_model_sr1_pml_nocov,
            fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea", "srmr"))
fitmeasures(fit_model_sr2_pml_nocov,
            fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea", "srmr"))
#AG fits better than P for model with NO covariances between items of the same questionnaire,
#data treated as ordinal, and pml estimator (p=0.09)

# One vs 2 factor for models - WITH covariances
summary(fit_model_sr3_pml, fit.measures = T, standardized = T)
summary(fit_model_sr4_pml, fit.measures = T, standardized = T)
lavTestLRT(fit_model_sr3_pml, fit_model_sr4_pml)
fitmeasures(fit_model_sr3_pml,
            fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea", "srmr"))
fitmeasures(fit_model_sr4_pml,
            fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea", "srmr"))

```


## Step 2: Hormone Models - Saliva + Hair. All have no equality constraints. 
```{r HMs}
# First we run all four models WITH BOTH latent hormone (DHEA, T, E2) and neuroendocrine (ADR, GON, PUB) variables. Even though the one- and two-factor models are equivalent

# Define HM1 - one factor, no covariances, hair + saliva
hm1 <- "
#Latent Saliva Variables
sal_dhea =~ dhea1 + dhea2 + dhea3 + dhea4
sal_estr =~ estr1 + estr2 + estr3 + estr4
sal_test =~ test1 + test2 + test3 + test4

#Latent Hormone Variables
dhea =~ sal_dhea + dhea_hair
estr =~ sal_estr + estr_hair
test =~ sal_test + test_hair

#Latent Neuroendocrine Systems
puberty =~ dhea + estr + test

"

# Fit HM1 - can only get MLR to converge:

fit_hm1 <- cfa(hm1, data = hormones, missing = "ML", estimator = "MLR", se = "robust.mlr") #even with MLR, some estimated lv variances are negative

#fit_hm1 <- cfa(hm1, data = hormones, missing = "available.cases", estimator = "PML", se = "robust.mlr") #the optimizer warns that a solution has NOT been found!

# Summary Stats for HM1
summary(fit_hm1, fit.measures = T, standardized = T)
fitMeasures(fit_hm1,
            fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))

# Pictoral Representation of HM1
semPaths(fit_hm1)


# Define HM2 - two factors, no covariances, hair + saliva
hm2 <- "
#Latent Saliva Variables
sal_dhea =~ dhea1 + dhea2 + dhea3 + dhea4
sal_estr =~ estr1 + estr2 + estr3 + estr4
sal_test =~ test1 + test2 + test3 + test4

#Latent Hormone Variables
dhea =~ sal_dhea + dhea_hair
estr =~ sal_estr + estr_hair
test =~ sal_test + test_hair

#Latent Neuroendocrine Systems
adrenal =~ dhea + test

"

# Fit HM2 - can only get PML to converge:

#fit_hm2 <- cfa(hm2, data = hormones, missing = "ML", estimator = "MLR", se = "robust.mlr") #the optimizer warns that a solution has NOT been found!

fit_hm2 <- cfa(hm2, data = hormones, missing = "available.cases", estimator = "PML", se = "robust.mlr") # some dodgy stuff still happens but you can still get some estimates

# Summary Stats for HM2
summary(fit_hm2, fit.measures = T, standardized = T)
fitMeasures(fit_hm2, fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))

# Pictoral Representation of HM2
semPaths(fit_hm2)

# Define HM3 - one factor, WITH covariances, hair + saliva
hm3 <- "
#Latent Saliva Variables
sal_dhea =~ dhea1 + dhea2 + dhea3 + dhea4
sal_estr =~ estr1 + estr2 + estr3 + estr4
sal_test =~ test1 + test2 + test3 + test4

#Latent Hormone Variables
dhea =~ sal_dhea + dhea_hair
estr =~ sal_estr + estr_hair
test =~ sal_test + test_hair

#Latent Neuroendocrine Systems
puberty =~ dhea + estr + test

#Covariances for Saliva Sample Day 
dhea1 ~~ estr1 + test1
estr1 ~~ test1
dhea2 ~~ estr2 + test2
estr2 ~~ test2
dhea3 ~~ estr3 + test3
estr3 ~~ test3
dhea4 ~~ estr4 + test4
estr4 ~~ test4

#Covariances for Hair Sample 
dhea_hair ~~ estr_hair + test_hair
estr_hair ~~ test_hair
"

# Fit HM3
fit_hm3 <- cfa(hm3, data = hormones, missing = "ML", estimator = "MLR", se = "robust.mlr")
fit_hm3_pml <- cfa(hm3, data = hormones, missing = "available.cases", estimator = "PML", se = "robust.mlr")

# Summary Stats for HM3
summary(fit_hm3, fit.measures = T, standardized = T)
fitMeasures(fit_hm3,
            fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))

summary(fit_hm3_pml, fit.measures = T, standardized = T)
fitMeasures(fit_hm3_pml,
            fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))

# Pictoral Representation of HM3
semPaths(fit_hm3)


# Define HM4 - two factors, WITH covariances, hair + saliva 
hm4 <- "
#Latent Saliva Variables
sal_dhea =~ dhea1 + dhea2 + dhea3 + dhea4
sal_estr =~ estr1 + estr2 + estr3 + estr4
sal_test =~ test1 + test2 + test3 + test4

#Latent Hormone Variables
dhea =~ sal_dhea + dhea_hair
estr =~ sal_estr + estr_hair
test =~ sal_test + test_hair

#Latent Neuroendocrine Systems
adrenal =~ dhea + test

#Covariances for Saliva Sample Day
dhea1 ~~ estr1 + test1
estr1 ~~ test1
dhea2 ~~ estr2 + test2
estr2 ~~ test2
dhea3 ~~ estr3 + test3
estr3 ~~ test3
dhea4 ~~ estr4 + test4
estr4 ~~ test4

#Covariances for Hair Sample 
dhea_hair ~~ estr_hair + test_hair
estr_hair ~~ test_hair
"

# Fit HM4 - only PML converges:

#fit_hm4 <- cfa(hm4, data = hormones, missing = "ML", estimator = "MLR", se = "robust.mlr") #the optimizer warns that a solution has NOT been found! 
fit_hm4_pml <- cfa(hm4, data = hormones, missing = "available.cases", estimator = "PML", se = "robust.mlr") 

# Summary Stats for HM4
#summary(fit_hm4, fit.measures = T, standardized = T)
#fitMeasures(fit_hm4, fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))
summary(fit_hm4_pml, fit.measures = T, standardized = T)
fitMeasures(fit_hm4_pml, fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))

# Pictoral Representation of HM4
semPaths(fit_hm4)

lavTestLRT(fit_hm1, fit_hm3)
lavTestLRT(fit_hm2, fit_hm4_pml)

lavTestLRT(fit_hm1, fit_hm2)
lavTestLRT(fit_hm3, fit_hm4_pml)


# Second, we run all four models without the latent hormone (DHEA, T, E2) variables and everything loads directly onto neuroendocrine (ADR, GON, PUB) variables. These are HMv2 (hormone models version 2)

# Define HM1v2 - one factor, no covariances, hair + saliva
hm1v2 <- "
#Latent Saliva Variables
sal_dhea =~ dhea1 + dhea2 + dhea3 + dhea4
sal_estr =~ estr1 + estr2 + estr3 + estr4
sal_test =~ test1 + test2 + test3 + test4

#Latent Neuroendocrine Systems
puberty =~ sal_dhea + sal_estr + sal_test + dhea_hair + estr_hair + test_hair

"

# Fit HM1v2:

fit_hm1v2 <- cfa(hm1v2, data = hormones, missing = "ML", estimator = "MLR", se = "robust.mlr") 

fit_hm1v2_pml <- cfa(hm1v2, data = hormones, missing = "available.cases", estimator = "PML", se = "robust.mlr") 

# Summary Stats for HM1
summary(fit_hm1v2, fit.measures = T, standardized = T)
fitMeasures(fit_hm1v2,
            fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))
summary(fit_hm1v2_pml, fit.measures = T, standardized = T)
fitMeasures(fit_hm1v2_pml,
            fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))

# Pictoral Representation of HM1
semPaths(fit_hm1v2)
semPaths(fit_hm1v2_pml)

# Define HM2 - two factors, no covariances, hair + saliva
hm2v2 <- "
#Latent Saliva Variables
sal_dhea =~ dhea1 + dhea2 + dhea3 + dhea4
sal_estr =~ estr1 + estr2 + estr3 + estr4
sal_test =~ test1 + test2 + test3 + test4

#Latent Neuroendocrine Systems
adrenal =~ sal_dhea + sal_test + dhea_hair + test_hair
gonadal =~ sal_estr + estr_hair
"

# Fit HM2v2:

fit_hm2v2 <- cfa(hm2v2, data = hormones, missing = "ML", estimator = "MLR", se = "robust.mlr") 
fit_hm2v2_pml <- cfa(hm2v2, data = hormones, missing = "available.cases", estimator = "PML", se = "robust.mlr") 

# Summary Stats for HM2v2
summary(fit_hm2v2, fit.measures = T, standardized = T)
fitMeasures(fit_hm2v2, fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))
summary(fit_hm2v2_pml, fit.measures = T, standardized = T)
fitMeasures(fit_hm2v2_pml, fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))

# Pictoral Representation of HM2v2
semPaths(fit_hm2v2)
semPaths(fit_hm2v2_pml)

# Define HM3v2 - one factor, WITH covariances, hair + saliva
hm3v2 <- "
#Latent Saliva Variables
sal_dhea =~ dhea1 + dhea2 + dhea3 + dhea4
sal_estr =~ estr1 + estr2 + estr3 + estr4
sal_test =~ test1 + test2 + test3 + test4

#Latent Neuroendocrine Systems
puberty =~ sal_dhea + sal_estr + sal_test + dhea_hair + estr_hair + test_hair

#Covariances for Saliva Sample Day 
dhea1 ~~ estr1 + test1
estr1 ~~ test1
dhea2 ~~ estr2 + test2
estr2 ~~ test2
dhea3 ~~ estr3 + test3
estr3 ~~ test3
dhea4 ~~ estr4 + test4
estr4 ~~ test4

#Covariances for Hair Sample 
dhea_hair ~~ estr_hair + test_hair
estr_hair ~~ test_hair
"

# Fit HM3v2
fit_hm3v2 <- cfa(hm3v2, data = hormones, missing = "ML", estimator = "MLR", se = "robust.mlr")
fit_hm3v2_pml <- cfa(hm3v2, data = hormones, missing = "available.cases", estimator = "PML", se = "robust.mlr")

# Summary Stats for HM3
summary(fit_hm3v2, fit.measures = T, standardized = T)
fitMeasures(fit_hm3v2,
            fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))

summary(fit_hm3v2_pml, fit.measures = T, standardized = T)
fitMeasures(fit_hm3v2_pml,
            fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))

# Pictoral Representation of HM3v2
semPaths(fit_hm3v2)
semPaths(fit_hm3v2_pml)

# Define HM4v2 - two factors, WITH covariances, hair + saliva 
hm4v2 <- "
#Latent Saliva Variables
sal_dhea =~ dhea1 + dhea2 + dhea3 + dhea4
sal_estr =~ estr1 + estr2 + estr3 + estr4
sal_test =~ test1 + test2 + test3 + test4

#Latent Neuroendocrine Systems
adrenal =~ sal_dhea + sal_test + dhea_hair + test_hair
gonadal =~ sal_estr + estr_hair

#Covariances for Saliva Sample Day
dhea1 ~~ estr1 + test1
estr1 ~~ test1
dhea2 ~~ estr2 + test2
estr2 ~~ test2
dhea3 ~~ estr3 + test3
estr3 ~~ test3
dhea4 ~~ estr4 + test4
estr4 ~~ test4

#Covariances for Hair Sample 
dhea_hair ~~ estr_hair + test_hair
estr_hair ~~ test_hair
"

# Fit HM4v2:

fit_hm4v2 <- cfa(hm4v2, data = hormones, missing = "ML", estimator = "MLR", se = "robust.mlr") 
fit_hm4v2_pml <- cfa(hm4v2, data = hormones, missing = "available.cases", estimator = "PML", se = "robust.mlr") 

# Summary Stats for HM4v2
summary(fit_hm4v2, fit.measures = T, standardized = T)
fitMeasures(fit_hm4v2, fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))
summary(fit_hm4v2_pml, fit.measures = T, standardized = T)
fitMeasures(fit_hm4v2_pml, fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))

# Pictoral Representation of HM4
semPaths(fit_hm4v2)
semPaths(fit_hm4v2_pml)

#Compare models
lavTestLRT(fit_hm1v2_pml, fit_hm3v2_pml) # 1 factor with or w/o covar?
lavTestLRT(fit_hm2v2_pml, fit_hm4v2_pml) # 2 factor with or w/o covar?

lavTestLRT(fit_hm1v2_pml, fit_hm2v2_pml) # 1 or 2 factor w/o covar?
lavTestLRT(fit_hm3v2_pml, fit_hm4v2_pml) # 1 or 2 factor with covar?

```

## Step 3: Post hoc Hormone Models 1 - Saliva ONLY. All have no equality Constraints
```{r SLMs}
# Define SLM1 - one factor, no covariances, saliva
slm1 <- "
#Latent Saliva Variables
dhea =~ dhea1 + dhea2 + dhea3 + dhea4
estr =~ estr1 + estr2 + estr3 + estr4
test =~ test1 + test2 + test3 + test4

#Latent Neuroendocrine Systems
puberty =~ dhea + estr + test
"

# Fit SLM1
fit_slm1 <- cfa(slm1, data = hormones, missing = "ML", estimator = "MLR", se = "robust.mlr")
fit_slm1_pml <- cfa(slm1, data = hormones, missing = "available.cases", estimator = "PML", se = "robust.mlr")

# Summary Stats for SLM1
summary(fit_slm1, fit.measures = T, standardized = T)
fitMeasures(fit_slm1,
            fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))
summary(fit_slm1_pml, fit.measures = T, standardized = T)
fitMeasures(fit_slm1_pml,
            fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))

# Pictoral Representation of HM1
semPaths(fit_slm1)


# Define SLM2 - two factors, no covariances, saliva only
slm2 <- "
#Latent Saliva Variables
dhea =~ dhea1 + dhea2 + dhea3 + dhea4
estr =~ estr1 + estr2 + estr3 + estr4
test =~ test1 + test2 + test3 + test4

#Latent Neuroendocrine Systems
adrenal =~ dhea + test
"

# Fit SLM2
fit_slm2 <- cfa(slm2, data = hormones, missing = "ML", estimator = "MLR", se = "robust.mlr") 
fit_slm2_pml <- cfa(slm2, data = hormones, missing = "available.cases", estimator = "PML", se = "robust.mlr") 

# Summary Stats for SLM2
summary(fit_slm2, fit.measures = T, standardized = T)
fitMeasures(fit_slm2, fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))
summary(fit_slm2_pml, fit.measures = T, standardized = T)
fitMeasures(fit_slm2_pml, fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))

# Pictoral Representation of SLM2
semPaths(fit_slm2)

# Define SLM3 - one factor, WITH covariances, saliva only
slm3 <- "
#Latent Saliva Variables
dhea =~ dhea1 + dhea2 + dhea3 + dhea4
estr =~ estr1 + estr2 + estr3 + estr4
test =~ test1 + test2 + test3 + test4

#Latent Neuroendocrine Systems
puberty =~ dhea + estr + test

#Covariances for Saliva Sample Day 
dhea1 ~~ estr1 + test1
estr1 ~~ test1
dhea2 ~~ estr2 + test2
estr2 ~~ test2
dhea3 ~~ estr3 + test3
estr3 ~~ test3
dhea4 ~~ estr4 + test4
estr4 ~~ test4
"

# Fit SLM3
fit_slm3 <- cfa(slm3, data = hormones, missing = "ML", estimator = "MLR", se = "robust.mlr")
fit_slm3_pml <- cfa(slm3, data = hormones, missing = "available.cases", estimator = "PML", se = "robust.mlr")

# Summary Stats for SLM3
summary(fit_slm3, fit.measures = T, standardized = T)
fitMeasures(fit_slm3,
            fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))
summary(fit_slm3_pml, fit.measures = T, standardized = T)
fitMeasures(fit_slm3_pml,
            fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))

# Pictoral Representation of SLM3
semPaths(fit_slm3)
semPaths(fit_slm3_pml)

# Define HM4 - two factors, WITH covariances, hair + saliva
slm4 <- "
#Latent Saliva Variables
dhea =~ dhea1 + dhea2 + dhea3 + dhea4
estr =~ estr1 + estr2 + estr3 + estr4
test =~ test1 + test2 + test3 + test4

#Latent Neuroendocrine Systems
adrenal =~ dhea + test

#Covariances for Saliva Sample Day
dhea1 ~~ estr1 + test1
estr1 ~~ test1
dhea2 ~~ estr2 + test2
estr2 ~~ test2
dhea3 ~~ estr3 + test3
estr3 ~~ test3
dhea4 ~~ estr4 + test4
estr4 ~~ test4
"

# Fit SLM4
fit_slm4 <- cfa(slm4, data = hormones, missing = "ML", estimator = "MLR", se = "robust.mlr")
fit_slm4_pml <- cfa(slm4, data = hormones, missing = "available.cases", estimator = "PML", se = "robust.mlr") 

# Summary Stats for HM4
summary(fit_slm4, fit.measures = T, standardized = T)
fitMeasures(fit_slm4, fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))
summary(fit_slm4_pml, fit.measures = T, standardized = T)
fitMeasures(fit_slm4_plm, fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))

# Pictoral Representation of HM4
semPaths(fit_slm4)

# Here's where we realize that SLM2 and 4 are pointless because they're equivalent to 1 and 3. So, here we only compare 1 and 3 (one-factor models):
lavTestLRT(fit_slm1_pml, fit_slm3_pml) # 1 factor with or w/o covar?

```


## Step 4 - Post hoc hormone Models 2 - Hair Predicts Saliva
```{r Hair Predicts Saliva}
# Define HSM1 (hair saliva model with method factors)
hsm1 <- "
#Latent Saliva Variables
sal_dhea =~ dhea1 + dhea2 + dhea3 + dhea4
sal_estr =~ estr1 + estr2 + estr3 + estr4
sal_test =~ test1 + test2 + test3 + test4

#Regressions
sal_dhea ~ dhea_hair
sal_estr ~ estr_hair
sal_test ~ test_hair

#Covariances for Sample Day
dhea1 ~~ estr1 + test1
estr1 ~~ test1
dhea2 ~~ estr2 + test2
estr2 ~~ test2
dhea3 ~~ estr3 + test3
estr3 ~~ test3
dhea4 ~~ estr4 + test4
estr4 ~~ test4

#Methods Factors
hair =~ dhea_hair + estr_hair + test_hair
saliva =~ sal_dhea + sal_estr + sal_test

#Set Latent Var Covariances to Zero
hair ~~ 0*saliva
"

# Define HSM2 - No methods factors
hsm2 <- "
#Latent Saliva Variables
sal_dhea =~ dhea1 + dhea2 + dhea3 + dhea4
sal_estr =~ estr1 + estr2 + estr3 + estr4
sal_test =~ test1 + test2 + test3 + test4

#Regressions
sal_dhea ~ dhea_hair
sal_estr ~ estr_hair
sal_test ~ test_hair

#Covariances for Sample Day
dhea1 ~~ estr1 + test1
estr1 ~~ test1
dhea2 ~~ estr2 + test2
estr2 ~~ test2
dhea3 ~~ estr3 + test3
estr3 ~~ test3
dhea4 ~~ estr4 + test4
estr4 ~~ test4
"

# Fit HSM1 All Data
fit_hsm1 <- cfa(hsm1, data = hormones, missing = "ML", estimator = "MLR", se = "robust.mlr")
fit_hsm1_pml <- cfa(hsm1, data = hormones, missing = "available.cases", estimator = "PML", se = "robust.mlr")

# Summary Stats for HSM1
summary(fit_hsm1, fit.measures = T, standardized = T) 
fitMeasures(fit_hsm1, fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))
summary(fit_hsm1_pml, fit.measures = T, standardized = T) 
fitMeasures(fit_hsm1_pml, fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))

# Fit Model HSM2
fit_hsm2 <- cfa(hsm2, data = hormones, missing = "ML", estimator = "MLR", se = "robust.mlr")
fit_hsm2_pml <- cfa(hsm2, data = hormones, missing = "available.cases", estimator = "PML", se = "robust.mlr")

# Summary Stats for HSM2
summary(fit_hsm2, fit.measures = T, standardized = T) 
fitMeasures(fit_hsm2, fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))
summary(fit_hsm2_pml, fit.measures = T, standardized = T) 
fitMeasures(fit_hsm2_pml, fit.measures = c("cfi","ecvi","mfi", "chisq", "pvalue", "rmsea"))

# Pictoral Representation of HSMs
semPaths(fit_hsm1_pml)
semPaths(fit_hsm2_pml)

# Comparing Model Fits - wait these don't work
anova(fit_hsm1, fit_hsm2)
lrtest(fit_hsm1, fit_hsm2)

```

```{r}
# Define Full Model 0
fullmod_0 <- "
#Latent Variables

#Saliva - Level 1
sal_dhea =~ dhea1 + dhea2 + dhea3 + dhea4
sal_estr =~ estr1 + estr2 + estr3 + estr4
sal_test =~ test1 + test2 + test3 + test4

#Hormones (Saliva + Hair) - Level 2
dhea =~ sal_dhea + dhea_hair
estr =~ sal_estr + estr_hair
test =~ sal_test + test_hair

#Self-Report
adrenal_sr =~ PDS2 + PDS3 + PBIP2
gonadal_sr =~ PDS1 + PDS4 + PDS6 + PBIP1

#Neuroendocrine Systems (Saliva + Hair + Qs) - Level 3
adrenal =~ dhea + test + adrenal_sr
gonadal =~ estr + gonadal_sr

#Covariances for Saliva Sample Day
dhea1 ~~ estr1 + test1
estr1 ~~ test1
dhea2 ~~ estr2 + test2
estr2 ~~ test2
dhea3 ~~ estr3 + test3
estr3 ~~ test3
dhea4 ~~ estr4 + test4
estr4 ~~ test4

#Covariances for Hair 
dhea_hair ~~ estr_hair + test_hair
estr_hair ~~ test_hair
"

# Fit Full Model 0
fit_fullmod_0_wlsmv <- cfa(fullmod_0, data = data_ord, estimator = "WLSMV", 
                       missing = "pairwise", verbose = T)

fit_fullmod_0a <- cfa(fullmod_0, data = data, missing = "ML", estimator = "MLR", se = "robust.mlr")

summary(fit_fullmod_0a, fit.measures=T, standardized=T)
summary(fit_fullmod_0_wlsmv, fit.measures=T, standardized=T)
fitMeasures(fit_fullmod_0_wlsmv)
# This line is more correct, but takes awhile to run...
fit_fullmod_0_pml <- cfa(fullmod_0, data = data, estimator = "PML", 
                      missing = "available.cases", verbose = T,  
                     ordered = c("PDS1","PDS2","PDS3","PDS4",
                                 "PDS6","PBIP1","PBIP2"))

# Summary Stats for Full Model 0
summary(fit_fullmod_0_wlsmv, fit.measures = T, standardized = T)
summary(fit_fullmod_0_pml, fit.measures = T, standardized = T)

fit_fullmod_0_wlsmv_parest <- parameterEstimates(fit_fullmod_0_wlsmv)

fit_fullmod_0_pml_parest <- parameterEstimates(fit_fullmod_0_pml)
lavaan:::ctr_pml_plrt(fit_fullmod_0_pml)

# Pictoral Representation of Full Model 0
semPaths(fit_fullmod_0_wlsmv)
semPaths(fit_fullmod_0_pml)

fitmeasures(fit_fullmod_0_wlsmv,
            fit.measures = c("cfi","ecvi","mfi"))
fitmeasures(fit_fullmod_0_pml,
            fit.measures = c("cfi","ecvi","mfi"))

```
```{r}
#Full models with overall puberty factor instead of A+G
fullmod_1 <- "
#Latent Variables

#Saliva - Level 1
sal_dhea =~ dhea1 + dhea2 + dhea3 + dhea4
sal_estr =~ estr1 + estr2 + estr3 + estr4
sal_test =~ test1 + test2 + test3 + test4

#Hormones (Saliva + Hair) - Level 2
dhea =~ sal_dhea + dhea_hair
estr =~ sal_estr + estr_hair
test =~ sal_test + test_hair

#Self-Report
pub_sr =~ PDS1 + PDS2 + PDS3 + PDS4 + PDS6 + PBIP1 + PBIP2

#BioVars
pub_bio =~ dhea + estr + test

#Neuroendocrine Systems (Saliva + Hair + Qs) - Level 3
puberty =~ pub_sr + pub_bio

#Covariances for Saliva Sample Day
dhea1 ~~ estr1 + test1
estr1 ~~ test1
dhea2 ~~ estr2 + test2
estr2 ~~ test2
dhea3 ~~ estr3 + test3
estr3 ~~ test3
dhea4 ~~ estr4 + test4
estr4 ~~ test4

#Covariances for Hair 
dhea_hair ~~ estr_hair + test_hair
estr_hair ~~ test_hair


"

# Fit Full Model 1
fit_fullmod_1_wlsmv <- cfa(fullmod_1, data = data_ord, estimator = "WLSMV", 
                       missing = "pairwise", verbose = T)
#can't run this...

# This line is more correct, but takes awhile to run...
fit_fullmod_1_pml <- cfa(fullmod_1, data = data, estimator = "PML", 
                      missing = "available.cases", verbose = T,  
                     ordered = c("PDS1","PDS2","PDS3","PDS4",
                                 "PDS6","PBIP1","PBIP2"))

# Summary Stats for Full Model 1
summary(fit_fullmod_1_wlsmv, fit.measures = T, standardized = T) # this won't run for me - MLB
summary(fit_fullmod_1_pml, fit.measures = T, standardized = T) # this either - MLB
summary(fit_fullmod_1_pml) # hell yes this works - MLB

# Pictoral Representation of Full Model 1
semPaths(fit_fullmod_1_pml)

fitmeasures(fit_fullmod_1_pml,
            fit.measures = c("cfi","ecvi","mfi")) # oh no - MLB
fitmeasures(fit_fullmod_0_pml,
            fit.measures = c("cfi","ecvi","mfi"))
anova(fit_fullmod_0_pml, fit_fullmod_1_pml)
lrtest(fit_fullmod_0_pml, fit_fullmod_1_pml)

```

```{r}
# Define Full Model 2 - No Hair Variables
fullmod_2 <- "
#Latent Variables

#Saliva - Level 1
sal_dhea =~ dhea1 + dhea2 + dhea3 + dhea4
sal_estr =~ estr1 + estr2 + estr3 + estr4
sal_test =~ test1 + test2 + test3 + test4

#Self-Report
adrenal_sr =~ PDS2 + PDS3 + PBIP2
gonadal_sr =~ PDS1 + PDS4 + PDS6 + PBIP1

#Neuroendocrine Systems
a_bio =~ sal_dhea + sal_test
adrenal =~ a_bio + adrenal_sr
gonadal =~ sal_estr + gonadal_sr

#Covariances for Saliva Sample Day
dhea1 ~~ estr1 + test1
estr1 ~~ test1
dhea2 ~~ estr2 + test2
estr2 ~~ test2
dhea3 ~~ estr3 + test3
estr3 ~~ test3
dhea4 ~~ estr4 + test4
estr4 ~~ test4

#Set some latent var covars to zero
a_bio ~~ 0*gonadal
"

# Fit Full Model 2
fit_fullmod_2_wlsmv <- cfa(fullmod_2, data = data_ord, estimator = "WLSMV", 
                       missing = "pairwise", verbose = T)

# This line is more correct, but takes awhile to run...
fit_fullmod_2_pml <- cfa(fullmod_2, data = data, estimator = "PML", 
                      missing = "available.cases", verbose = T,  
                     ordered = c("PDS2","PDS3","PDS1","PDS4",
                                 "PDS6","PBIP1","PBIP2"))

# Summary Stats for Full Model 2
summary(fit_fullmod_2_wlsmv, fit.measures = T, standardized = T)
summary(fit_fullmod_2_pml, fit.measures = T, standardized = T)

# Pictoral Representation of Full Model 2
semPaths(fit_fullmod_2_wlsmv)

fitmeasures(fit_fullmod_2_wlsmv,
            fit.measures = c("cfi","ecvi","mfi"))
fitmeasures(fit_fullmod_0_wlsmv,
            fit.measures = c("cfi","ecvi","mfi"))
fitmeasures(fit_fullmod_2_pml,
            fit.measures = c("cfi","ecvi","mfi"))

anova(fit_fullmod_0_wlsmv, fit_fullmod_2_wlsmv)
# model with hair seems to fit better (see mfi for example)


```

```{r}
# Define Full Model 3 - No Hair Variables - Puberty Factor Instead of A+G
fullmod_3 <- "
#Latent Variables

#Saliva - Level 1
sal_dhea =~ dhea1 + dhea2 + dhea3 + dhea4
sal_estr =~ estr1 + estr2 + estr3 + estr4
sal_test =~ test1 + test2 + test3 + test4

#Self-Report
pub_sr =~ PDS2 + PDS3 + PDS1 + PDS4 + PDS6 + PBIP1 + PBIP2

#Neuroendocrine Systems (Saliva + Hair + Qs) - Level 3
pub_bio =~ sal_dhea + sal_estr + sal_test

#Puberty
puberty =~ pub_sr + pub_bio

#Covariances for Saliva Sample Day
dhea1 ~~ estr1 + test1
estr1 ~~ test1
dhea2 ~~ estr2 + test2
estr2 ~~ test2
dhea3 ~~ estr3 + test3
estr3 ~~ test3
dhea4 ~~ estr4 + test4
estr4 ~~ test4
"

# Fit Full Model 3
fit_fullmod_3_wlsmv <- cfa(fullmod_3, data = data_ord, estimator = "WLSMV", 
                       missing = "pairwise", verbose = T)

# This line is more correct, but takes awhile to run...
fit_fullmod_3_pml <- cfa(fullmod_3, data = data, estimator = "PML", 
                      missing = "available.cases", verbose = T,  
                     ordered = c("PDS1","PDS2","PDS3","PDS4",
                                 "PDS6","PBIP1","PBIP2"))

# Summary Stats for Full Model 3
summary(fit_fullmod_3_wlsmv, fit.measures = T, standardized = T)
summary(fit_fullmod_3_pml, fit.measures = T, standardized = T)

# Pictoral Representation of Full Model 3
semPaths(fit_fullmod_3_wlsmv)
semPaths(fit_fullmod_3_pml)

fitmeasures(fit_fullmod_3_wlsmv,
            fit.measures = c("cfi","ecvi","mfi"))
fitmeasures(fit_fullmod_3_pml,
            fit.measures = c("cfi","ecvi","mfi"))

anova(fit_fullmod_1_wlsmv, fit_fullmod_3_wlsmv)
anova(fit_fullmod_2_wlsmv, fit_fullmod_3_wlsmv)

```

```{r Bio predicts Self-Report SEM}
# Define SEM Model 1 - Does Salivary Puberty predict Self-Reported A + G?
semmod_1 <- "
#Latent Variables

#Saliva - Level 1
sal_dhea =~ dhea1 + dhea2 + dhea3 + dhea4
sal_gonadal =~ estr1 + estr2 + estr3 + estr4
sal_test =~ test1 + test2 + test3 + test4

#Saliva Adrenal
sal_adrenal =~ sal_dhea + sal_test

#Self-Report
adrenal_sr =~ PDS2 + PDS3 + PBIP2
gonadal_sr =~ PDS1 + PDS4 + PDS6 + PBIP1

#Regressions
adrenal_sr ~ sal_adrenal
gonadal_sr ~ sal_gonadal

#Covariances for Saliva Sample Day
dhea1 ~~ estr1 + test1
estr1 ~~ test1
dhea2 ~~ estr2 + test2
estr2 ~~ test2
dhea3 ~~ estr3 + test3
estr3 ~~ test3
dhea4 ~~ estr4 + test4
estr4 ~~ test4
"

# Define SEM Model 2 - Does Salivary Puberty predict Self-Reported Puberty?
semmod_2 <- "
#Latent Variables

#Saliva
sal_dhea =~ dhea1 + dhea2 + dhea3 + dhea4
sal_estr =~ estr1 + estr2 + estr3 + estr4
sal_test =~ test1 + test2 + test3 + test4

#Bio Puberty
bio_puberty =~ sal_dhea + sal_estr + sal_test

#Self-Report Puberty
sr_puberty =~ PDS2 + PDS3 + PDS1 + PDS4 + PDS6 + PBIP1 + PBIP2

#Regressions
sr_puberty ~ bio_puberty

#Covariances for Saliva Sample Day
dhea1 ~~ estr1 + test1
estr1 ~~ test1
dhea2 ~~ estr2 + test2
estr2 ~~ test2
dhea3 ~~ estr3 + test3
estr3 ~~ test3
dhea4 ~~ estr4 + test4
estr4 ~~ test4
"

# Fit SEM Model 1
fit_semmod_1_wlsmv <- cfa(semmod_1, data = data_ord, estimator = "WLSMV", 
                       missing = "pairwise", verbose = T)
fit_semmod_1_pml <- cfa(semmod_1, data = data, estimator = "PML", 
                      missing = "available.cases", verbose = T,  
                     ordered = c("PDS2","PDS3","PDS1","PDS4",
                                 "PDS6","PBIP1","PBIP2"))

# Pictoral Representation of SEM Model 1
semPaths(fit_semmod_1_wlsmv)

# Summary Stats for SEM Model 1
summary(fit_semmod_1_wlsmv, fit.measures = T, standardized = T)
summary(fit_semmod_1_pml, fit.measures = T, standardized = T)

# Fit SEM Model 2
fit_semmod_2_wlsmv <- cfa(semmod_2, data = data_ord, estimator = "WLSMV", 
                       missing = "pairwise", verbose = T)
fit_semmod_2_pml <- cfa(semmod_2, data = data, estimator = "PML", 
                      missing = "available.cases", verbose = T,  
                     ordered = c("PDS2","PDS3","PDS1","PDS4",
                                 "PDS6","PBIP1","PBIP2"))

# Summary Stats for SEM Model 2
summary(fit_semmod_2_wlsmv, fit.measures = T, standardized = T)
summary(fit_semmod_2_pml, fit.measures = T, standardized = T)

anova(fit_semmod_1_wlsmv, fit_semmod_2_wlsmv)
semPaths(fit_semmod_2_wlsmv)

#Comparing Model Fits
fitmeasures(fit_semmod_1_wlsmv,
            fit.measures = c("cfi","ecvi","mfi","pvalue"))
fitmeasures(fit_semmod_2_wlsmv,
            fit.measures = c("cfi","ecvi","mfi","pvalue"))
```

```{r}
#Extracting Latent Variable Estimates per Subject
semmod1_extract_vars <- lavPredict(fit_semmod_1_wlsmv)
semmod2_extract_vars <- lavPredict(fit_semmod_2_wlsmv)

#Correlation Matrices for Latent Var Estimates
cor(semmod1_extract_vars)
cor(semmod2_extract_vars)

# "P" bio predict self-report
plot(semmod2_extract_vars[,"sr_puberty"] ~ semmod2_extract_vars[,"bio_puberty"], ylab = "Extracted Latent Variable Estimate for Self-Reported Puberty", xlab = "Extracted Latent Variable Estimate for Salivary Puberty") + title(main = "Latent Biological Puberty (Salivary Hormones)\n predicts Latent Self-Reported Puberty") + abline(lm(semmod2_extract_vars[,"sr_puberty"] ~ semmod2_extract_vars[,"bio_puberty"])) + 
  text(x=1.75, y=1.75, labels = bquote(italic(R)^2 == .(format(0.4034))))

# "A" bio predict "A" self-report
plot(semmod1_extract_vars[,"adrenal_sr"] ~ semmod1_extract_vars[,"sal_adrenal"], ylab = "Extracted Latent Variable Estimate\n for Self-Reported Adrenal Development", xlab = "Extracted Latent Variable Estimate\n for Salivary Adrenal Stage") + title(main = "Latent Biological Adrenal Development\n (Salivary DHEA & Testosterone)\n predicts Latent Self-Reported Adrenal Development") + abline(lm(semmod1_extract_vars[,"adrenal_sr"] ~ semmod1_extract_vars[,"sal_adrenal"])) + 
  text(x=1.75, y=1.75, labels = bquote(italic(R)^2 == .(format(0.3697))))

# "G" bio predict "G" self-report
plot(semmod1_extract_vars[,"gonadal_sr"] ~ semmod1_extract_vars[,"sal_gonadal"], ylab = "Extracted Latent Variable Estimate\n for Self-Reported Gonadal Development", xlab = "Extracted Latent Variable Estimate\n for Salivary Gonadal Stage") + title(main = "Latent Biological Gonadal Development\n (Salivary Estradiol)\n predicts Latent Self-Reported Gonadal Development") + abline(lm(semmod1_extract_vars[,"gonadal_sr"] ~ semmod1_extract_vars[,"sal_gonadal"])) + 
  text(x=0.2, y=1, labels = bquote(italic(R)^2 == .(format(0.3926))))


```
